# RemoteJuggler Install Script & npm Wrapper Testing
# Tests the installation experience on fresh systems

name: Test Installation

on:
  push:
    paths:
      - 'install.sh'
      - 'scripts/install.sh'
      - 'scripts/configure-mcp-clients.sh'
      - 'npm/**'
      - '.github/workflows/test-install.yml'
    branches: [main, develop]
  pull_request:
    paths:
      - 'install.sh'
      - 'scripts/install.sh'
      - 'scripts/configure-mcp-clients.sh'
      - 'npm/**'
  workflow_dispatch:

env:
  CHAPEL_VERSION: "2.7.0"

jobs:
  # ===========================================================================
  # Test install.sh on Linux
  # ===========================================================================

  test-install-linux:
    name: Install Script (Linux)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Chapel and build binary
        run: |
          wget -q https://github.com/chapel-lang/chapel/releases/download/${CHAPEL_VERSION}/chapel-${CHAPEL_VERSION}-1.ubuntu24.amd64.deb
          sudo apt-get install -y ./chapel-${CHAPEL_VERSION}-1.ubuntu24.amd64.deb

      - name: Build release binary
        run: mason build --release

      - name: Simulate GitHub Release (local binary)
        run: |
          # Create a mock release directory
          mkdir -p /tmp/mock-release
          cp target/release/remote_juggler /tmp/mock-release/remote-juggler-linux-amd64
          chmod +x /tmp/mock-release/remote-juggler-linux-amd64

          # Start a simple HTTP server for download testing
          cd /tmp/mock-release
          python3 -m http.server 8888 &
          sleep 1

      - name: Test install.sh (local download)
        env:
          REMOTE_JUGGLER_VERSION: "2.1.0-beta.1"
        run: |
          # Override download to use local server
          # Test the install script's platform detection and directory setup
          export HOME=$(mktemp -d)
          mkdir -p "$HOME/.local/bin"
          export PATH="$HOME/.local/bin:$PATH"

          # Copy binary directly (simulating what install.sh would download)
          cp /tmp/mock-release/remote-juggler-linux-amd64 "$HOME/.local/bin/remote-juggler"
          chmod +x "$HOME/.local/bin/remote-juggler"

          # Verify binary works
          remote-juggler --help
          remote-juggler list || true

      - name: Test MCP mode
        run: |
          echo '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{"protocolVersion":"2025-11-25","capabilities":{},"clientInfo":{"name":"ci-test","version":"1.0"}}}' | \
            timeout 5 target/release/remote_juggler --mode=mcp || true

      - name: Test configure-mcp-clients.sh
        run: |
          export HOME=$(mktemp -d)
          mkdir -p "$HOME/.local/bin"
          export PATH="$HOME/.local/bin:$PATH"
          cp target/release/remote_juggler "$HOME/.local/bin/remote-juggler"
          chmod +x "$HOME/.local/bin/remote-juggler"

          # Create mock client directories
          mkdir -p "$HOME/.claude"
          mkdir -p "$HOME/.cursor"
          mkdir -p "$HOME/.config/Code/User"

          # Run the configurator
          sh scripts/configure-mcp-clients.sh

          # Verify configs were created
          test -f "$HOME/.claude/.mcp.json" && echo "Claude Code: OK"
          test -f "$HOME/.cursor/mcp.json" && echo "Cursor: OK"
          test -f "$HOME/.config/Code/User/mcp.json" && echo "VS Code: OK"

          # Verify configs contain remote-juggler
          grep -q "remote-juggler" "$HOME/.claude/.mcp.json"
          grep -q "remote-juggler" "$HOME/.cursor/mcp.json"
          grep -q "remote-juggler" "$HOME/.config/Code/User/mcp.json"

          echo "All MCP client configurations verified!"

  # ===========================================================================
  # Test npm wrapper
  # ===========================================================================

  test-npm-wrapper:
    name: npm Wrapper
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validate npm package
        run: |
          cd npm
          npm pack --dry-run
          echo "Package validation OK"

      - name: Test npm package structure
        run: |
          cd npm
          # Verify required files exist
          test -f package.json && echo "package.json: OK"
          test -f bin/cli.js && echo "bin/cli.js: OK"
          test -f bin/install.js && echo "bin/install.js: OK"
          test -f README.md && echo "README.md: OK"

          # Verify package.json fields
          node -e "
            const pkg = require('./package.json');
            console.assert(pkg.name === '@tinyland/remote-juggler', 'Wrong package name');
            console.assert(pkg.bin['remote-juggler'] === './bin/cli.js', 'Wrong bin path');
            console.assert(pkg.scripts.postinstall === 'node bin/install.js', 'Wrong postinstall');
            console.log('Package manifest validation: OK');
          "

      - name: Test install.js platform detection
        run: |
          cd npm
          node -e "
            // Test that install.js has valid platform mappings
            const script = require('fs').readFileSync('bin/install.js', 'utf-8');
            console.assert(script.includes('linux-x64'), 'Missing linux-x64 mapping');
            console.assert(script.includes('linux-arm64'), 'Missing linux-arm64 mapping');
            console.assert(script.includes('darwin-x64'), 'Missing darwin-x64 mapping');
            console.assert(script.includes('darwin-arm64'), 'Missing darwin-arm64 mapping');
            console.log('Platform mapping validation: OK');
          "

  # ===========================================================================
  # Test E2E with pytest on installed binary
  # ===========================================================================

  test-e2e-installed:
    name: E2E (Installed Binary)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Chapel
        run: |
          wget -q https://github.com/chapel-lang/chapel/releases/download/${CHAPEL_VERSION}/chapel-${CHAPEL_VERSION}-1.ubuntu24.amd64.deb
          sudo apt-get install -y ./chapel-${CHAPEL_VERSION}-1.ubuntu24.amd64.deb

      - name: Install runtime dependencies
        run: sudo apt-get update && sudo apt-get install -y libhwloc15

      - name: Build and install
        run: |
          mason build --release
          mkdir -p ~/.local/bin
          cp target/release/remote_juggler ~/.local/bin/remote-juggler
          chmod +x ~/.local/bin/remote-juggler
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Verify installation
        run: |
          which remote-juggler
          remote-juggler --help

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install test dependencies
        run: pip install -r test/e2e/requirements.txt

      - name: Run installation E2E tests
        run: |
          export REMOTE_JUGGLER_BIN="$HOME/.local/bin/remote-juggler"
          pytest test/e2e/test_installation.py -v \
            -m "not tpm and not secure_enclave and not yubikey and not hardware and not gpg" \
            --timeout=30

      - name: Run MCP protocol E2E tests
        run: |
          export REMOTE_JUGGLER_BIN="$HOME/.local/bin/remote-juggler"
          pytest test/e2e/test_mcp_protocol.py -v \
            -m "not tpm and not secure_enclave and not yubikey and not hardware" \
            --timeout=30

      - name: Run MCP tool E2E tests
        run: |
          export REMOTE_JUGGLER_BIN="$HOME/.local/bin/remote-juggler"
          pytest test/e2e/test_mcp_tools.py -v \
            -m "not tpm and not secure_enclave and not yubikey and not hardware and not keys" \
            --timeout=30

  # ===========================================================================
  # Validate server.json
  # ===========================================================================

  validate-registry:
    name: Validate MCP Registry
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate server.json
        run: |
          # Check server.json exists and is valid JSON
          test -f server.json && echo "server.json exists: OK"
          python3 -c "
          import json
          with open('server.json') as f:
              data = json.load(f)
          assert 'name' in data, 'Missing name field'
          assert 'description' in data, 'Missing description field'
          assert 'packages' in data, 'Missing packages field'
          assert len(data['packages']) > 0, 'No packages defined'
          print(f'Registry name: {data[\"name\"]}')
          print(f'Packages: {len(data[\"packages\"])}')
          print('server.json validation: OK')
          "

      - name: Validate .mcp.json
        run: |
          test -f .mcp.json && echo ".mcp.json exists: OK"
          python3 -c "
          import json
          with open('.mcp.json') as f:
              data = json.load(f)
          assert 'mcpServers' in data, 'Missing mcpServers'
          assert 'remote-juggler' in data['mcpServers'], 'Missing remote-juggler server'
          server = data['mcpServers']['remote-juggler']
          assert server['command'] == 'remote-juggler', 'Wrong command'
          assert '--mode=mcp' in server['args'], 'Missing --mode=mcp arg'
          print('.mcp.json validation: OK')
          "

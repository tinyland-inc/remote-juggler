#compdef remote-juggler
# Zsh completion for remote-juggler
# Install to /usr/local/share/zsh/site-functions/_remote-juggler

_remote-juggler() {
    local line state

    _arguments -C \
        '1: :_remote_juggler_commands' \
        '*:: :->args'

    case $state in
        args)
            case $line[1] in
                config)
                    _arguments '1: :(show add edit remove import sync init)'
                    ;;
                token)
                    _arguments '1: :(set get clear verify check-expiry renew)'
                    ;;
                gpg)
                    _arguments '1: :(status configure verify)'
                    ;;
                debug)
                    _arguments '1: :(ssh-config git-config keychain hsm)'
                    ;;
                keys|kdbx)
                    _arguments '1: :(init status search resolve get store delete list ingest crawl discover export)'
                    ;;
                pin)
                    _arguments '1: :(store clear status)'
                    ;;
                yubikey|yk)
                    _arguments '1: :(info set-pin-policy set-touch configure-trusted diagnostics)'
                    ;;
                trusted-workstation|tws)
                    _arguments '1: :(enable disable status verify)'
                    ;;
                security-mode)
                    _arguments '1: :(standard trusted_workstation hardware_only)'
                    ;;
                switch|to|validate|edit|remove|set|get|clear|configure)
                    _remote_juggler_identities
                    ;;
            esac
            ;;
    esac
}

_remote_juggler_commands() {
    local -a commands
    commands=(
        'list:List all configured identities'
        'detect:Detect identity for current repository'
        'switch:Switch to specified identity'
        'to:Alias for switch'
        'validate:Test SSH/API connectivity'
        'status:Show current identity status'
        'config:Configuration management'
        'token:Token management'
        'gpg:GPG signing management'
        'debug:Debug utilities'
        'keys:KeePassXC credential authority'
        'kdbx:Alias for keys'
        'pin:HSM PIN management'
        'yubikey:YubiKey management'
        'yk:Alias for yubikey'
        'trusted-workstation:Trusted workstation mode'
        'tws:Alias for trusted-workstation'
        'security-mode:Set security mode'
        'setup:Run setup wizard'
        'unseal-pin:Unseal HSM PIN'
        'verify:Verify GPG keys'
    )
    _describe 'command' commands
}

_remote_juggler_identities() {
    local -a identities
    identities=(${(f)"$(remote-juggler list 2>/dev/null | grep -E '^  - ' | sed 's/^  - //')"})
    _describe 'identity' identities
}

_remote-juggler "$@"
